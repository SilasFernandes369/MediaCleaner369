import * as FileSystem from 'expo-file-system';
import * as Crypto from 'expo-crypto';

/**
 * Calcula hash MD5 de forma otimizada
 * Para arquivos grandes, usa amostras estratégicas
 */
export async function calculateAssetHash(uri, fileSize) {
  try {
    // Ignorar arquivos muito pequenos
    if (fileSize < 100 * 1024) return null; // 100KB mínimo
    
    const chunkSize = 2 * 1024 * 1024; // 2MB por chunk
    const algorithm = Crypto.CryptoDigestAlgorithm.MD5;
    
    // Estratégia baseada no tamanho do arquivo
    if (fileSize <= 10 * 1024 * 1024) { // Até 10MB: hash completo
      const content = await FileSystem.readAsStringAsync(uri, {
        encoding: FileSystem.EncodingType.Base64,
      });
      return await Crypto.digestStringAsync(algorithm, content);
    } 
    
    // Para arquivos grandes: amostras estratégicas
    const samplePositions = [
      0, // Início
      Math.floor(fileSize * 0.25), // 25%
      Math.floor(fileSize * 0.5),  // 50%
      Math.floor(fileSize * 0.75), // 75%
      Math.max(0, fileSize - chunkSize) // Final
    ];
    
    let combinedContent = '';
    for (const position of samplePositions) {
      try {
        const chunk = await FileSystem.readAsStringAsync(uri, {
          encoding: FileSystem.EncodingType.Base64,
          position: Math.max(0, position),
          length: Math.min(chunkSize, fileSize - position),
        });
        combinedContent += chunk;
      } catch (e) {
        console.log('Erro ao ler chunk:', e);
      }
    }
    
    return await Crypto.digestStringAsync(algorithm, combinedContent);
  } catch (error) {
    console.error('Erro no cálculo do hash:', error);
    return null;
  }
}
